<div class="related">
    {% assign hasSimilar = '' %}
    {% for post in site.posts  %}
        {% assign postHasSimilar = false %}

        {% if postHasSimilar == false and hasSimilar.size < 5 and post != page and post.tags == page.tags %}
            {% if hasSimilar.size == 0 %}
            <h4>Related Posts: </h4>
            <ul>
            {% endif %}
            <li class="relatedPost">
                <a href="{{ site.url }}{{ post.url }}">{{ post.title }}
                {% if post.series %}
                    (Series: {{ post.series }})
                {% endif %}
                </a>
            </li>
            {% capture hasSimilar %}{{ hasSimilar }}*{% endcapture %}
            {% assign postHasSimilar = true %}
        {% endif %}
    {% endfor %}
    {% if hasSimilar.size > 0 %}
        </ul>
    {% endif %}
</div>
